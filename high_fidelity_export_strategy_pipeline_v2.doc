<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
<meta charset="utf-8">
<title>High-Fidelity Export Strategy Pipeline (v2)</title>
<style>
body { font-family: 'Calibri', 'Arial', sans-serif; line-height: 1.6; color: #333; }
h1 { color: #2E74B5; border-bottom: 2px solid #2E74B5; padding-bottom: 10px; margin-bottom: 20px; }
h2 { color: #1F4E79; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
h3 { color: #365F91; margin-top: 15px; margin-bottom: 5px; }
p { margin-bottom: 10px; }
ul { margin-bottom: 15px; margin-top: 5px; }
li { margin-bottom: 5px; }
code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 4px; font-family: Consolas, monospace; font-size: 0.9em; color: #c7254e; }
.highlight { background-color: #e8f4f8; padding: 15px; border-left: 5px solid #2E74B5; margin: 20px 0; }
.step { background-color: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
.step-title { font-weight: bold; color: #2E74B5; margin-bottom: 5px; display: block; }
.warning { background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 15px 0; }
</style>
</head>
<body>

<h1>High-Fidelity Export Strategy Pipeline (v2)</h1>

<p>This document details the comprehensive technical strategy to resolve node overlaps and legibility issues in PDF exports. Version 2.0 incorporates robust style resolution, segmentation safety valves, and UX previews.</p>

<h2>1. The Dual Challenge</h2>
<ul>
    <li><strong>The "Overlapping Nodes" Problem:</strong> Caused by <em>Style Detachment</em>. The export engine captures the DOM but misses external CSS/Variables, causing nodes to collapse visually.</li>
    <li><strong>The "Tiny Text" Problem:</strong> Caused by <em>Aggressive Downscaling</em>. Forcing large charts onto a fixed A4 page shrinks text to illegible sizes.</li>
</ul>

<h2>2. The Solution: High-Fidelity Pipeline</h2>

<h3>Component A: Pre-Flight Style Injection (Solves Overlaps)</h3>
<p>We must ensure the SVG is "self-contained" and has zero dependencies on the parent window.</p>

<div class="step">
    <span class="step-title">Step 1: Style Extraction</span>
    Programmatically scan <code>styles.css</code> to extract rules for <code>.org-chart-node</code>, <code>.person-entry</code>, etc.
</div>

<div class="step">
    <span class="step-title">Step 2: CSS Variable Resolution (Critical)</span>
    <p>SVGs exported as images cannot read CSS variables from the parent document's <code>:root</code>.</p>
    <ul>
        <li><strong>Action:</strong> Before injection, parse the extracted CSS string.</li>
        <li><strong>Logic:</strong> Replace every instance of <code>var(--variable-name)</code> with its computed Hex/RGB value (e.g., replace <code>var(--rrc-blue)</code> with <code>#0085f2</code>).</li>
        <li><strong>Result:</strong> Hardcoded, unbreakable styles.</li>
    </ul>
</div>

<div class="step">
    <span class="step-title">Step 3: Inline Injection & Font Embedding</span>
    <ul>
        <li>Inject the resolved CSS into a <code>&lt;style&gt;</code> block inside the SVG.</li>
        <li>Ensure font definitions (Roboto) are included as Data URIs if using Vector export, or ensure they are loaded in the canvas context for Raster export.</li>
    </ul>
</div>

<h3>Component B: Hybrid Dynamic Sizing (Solves Legibility)</h3>
<p>Replace fixed A4 constraint with content-aware sizing.</p>

<div class="step">
    <span class="step-title">Step 4: Accurate Measurement</span>
    Convert pixel dimensions to millimeters using <code>25.4 / 96</code> (or device pixel ratio if needed).
</div>

<div class="step">
    <span class="step-title">Step 5: Smart Page Dimensioning with Segmentation Fallback</span>
    <ul>
        <li><strong>Fits on A4:</strong> Use Standard A4 Landscape.</li>
        <li><strong>Large (Infinite Canvas):</strong> If > A4 but &lt; 5 Meters, set custom PDF page size to match chart exactly.</li>
        <li><strong>Massive (Segmentation Trigger):</strong> If dimensions > 5 Meters (approx 19,000px):
            <div class="warning"><strong>Action:</strong> Do not export single page. Trigger "Segmentation Fallback" modal suggesting the user export by Department (Atlas Strategy) to avoid browser crash or unopenable PDF.</div>
        </li>
    </ul>
</div>

<h3>Component C: UX & Feedback</h3>

<div class="step">
    <span class="step-title">Step 6: Pre-Export Summary</span>
    Before generating the file, show a lightweight toast/modal:
    <br><em>"Exporting as Custom Size: 1200mm x 600mm (Infinite Canvas)"</em>
    <br>This manages user expectations regarding printing.
</div>

<h2>3. Implementation Workflow</h2>
<p><strong>Location:</strong> <code>app/js/chart-editor.js</code> (Method: <code>exportPDF</code>)</p>

<ol>
    <li><strong>Analyze:</strong> Get chart dimensions.</li>
    <li><strong>Check Limits:</strong> If > Max, abort and show "Use Bulk Export" suggestion.</li>
    <li><strong>Prepare Styles:</strong> Fetch CSS -> Resolve Vars -> Inject into SVG.</li>
    <li><strong>Configure PDF:</strong> Set orientation (Portrait/Landscape) and Size (A4 vs Custom).</li>
    <li><strong>Generate:</strong> Run <code>html2canvas</code>/<code>jsPDF</code> pipeline.</li>
</ol>

</body>
</html>